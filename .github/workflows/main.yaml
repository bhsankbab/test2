name: Github Permission Manager
run-name: GitHUB pErm
on:
  workflow_dispatch:
    inputs:
      repo_list:
        required: true
        type: string
        description: Repo list, if more than one, specify as comma seperated values
        default: "-"
jobs:
  org_permission:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Permission Changing
        env:
          SUPER_SECRET: ${{ secrets.MY_TOKEN }}
          list: ${{ inputs.repo_list }}
        run: |
	        status_check=$(curl -L   -H "Accept: application/vnd.github+json"   -H "Authotion: Bearer $SUPER_SECRET"  -H "X-GitHub-Api-Version: 2022-11-28"  https://api.github.com/orgs/bhsankbab/actions/permissions | jq -r '.enabled_repositories')
          if [ "$status_check" == "selected" ]; then
            current_perm=$(curl -s  -L   -H "Accept: application/vnd.github+json"   -H "Authorization: Bearer $SUPER_SECRET"  -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/orgs/bhsankbab/actions/permissions/repositories?per_page | jq '.repositories | .[] | .id' | tr -s '\n' ',' | awk 'gsub(/,$/,x)')
            echo " $current_perm "
            idx=0
            idr=()
            IFS=',' read -r -a repo <<< "${{ inputs.repo_list }}"
            for p in "${repo[@]}"; do
            echo "executing $p"
            repo_id=$(curl -s  -L   -H "Accept: application/vnd.github+json"   -H "Authorization: Bearer ${{ secrets.MY_TOKEN }}"  -H "X-GitHub-Api-Version: 2022-11-28"  https://api.github.com/orgs/bhsankbab/repos | jq '.[] | select(.name=="'$p'") | .id')
            idr[idx]="$repo_id" #store data in array
            idx=$((idx+1)) #increment the counter
            done         
            printf -v joined '%s,' "${idr[@]}"
            echo "${joined%,}"          
            curl -L -X PUT  -H "Accept: application/vnd.github+json"   -H "Authorization: Bearer $SUPER_SECRET"  -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/orgs/bhsankbab/actions/permissions/repositories -d '{"selected_repository_ids":['$current_perm','${joined%,}']}'
            echo " Added New repo "
          else
            echo " ORG settings for Action Permission is not Seletected for Repositories. Please change it and run the workflow"
          fi       
        shell: bash


